/*
  Timed pulse button v002 for Arduino by Pasquale Lombardi. 1/12/2019 Free for home and personal non commercial use. 
*/
const int Puls = 3;
const int SwitchTime = 4;
const int SwitchTime2 = 5;
const int Rele1 = 13;

bool leggipin = false;    // Variables to save reading button states
bool leggiswitch = false;
bool leggiswitch2 = false;

bool stato2 = false;     // Output states to do checkings

bool flag_timer = false;     // Flags to set timer initializations states
bool flag_t1_settato = false;
bool flag_t2_settato = false;

long t_att;              // Times variables
long t;
long t1 = 3*60*1000;
long t2 = 30*1000;
long tc;

void setup() {
  
              pinMode(Puls, INPUT); 
              pinMode(SwitchTime, INPUT); 
              pinMode(SwitchTime2, INPUT); 
              pinMode(Rele1, OUTPUT);
  
              Serial.begin(9600); // Serial initialization to read ON OFF states

             }

void loop() {
  
            leggipin = digitalRead(Puls); // aggiorna variabile pin pulsante ad ogni ciclo
            leggiswitch = digitalRead(SwitchTime);
            leggiswitch2 = digitalRead(SwitchTime2); // aggiorna variabili switch
            stato2 = digitalRead(Rele1); // salva stato output in una variabile per effettuare pi√π facilmente confronti
  
            switch2();
  
            if (((leggipin)&&!stato2)||flag_timer) {
                                                             timer();//inizializza timer
                                                             if (!stato2) digitalWrite(Rele1,HIGH);
                                                            } 
            }
// Timer script, reviewed
bool timer () {
               tc = millis();
                if (!flag_timer) flag_timer = true;
                if ((leggiswitch)&&(!flag_t1_settato)) {
                                                               if (t!=t1){
                                                                          if (!leggiswitch2) {
                                                                                              Serial.print("Rele 3MIN ON");
                                                                                              Serial.println();  
                                                                                             } else {
                                                                                                     Serial.print("Rele 5S ON");
                                                                                                     Serial.println();        
                                                                                                    }
                                                                          t=t1;
                                                                          t_att = millis();
                                                                          flag_t1_settato = true;
                                                                          flag_t2_settato = false;
                                                                         }
                                                             }
                 else if ((!leggiswitch)&&(!flag_t2_settato)){ 
                                                              if (t!=t2) {
                                                                          if (!leggiswitch2) {
                                                                                              Serial.print("Rele 30S ON");
                                                                                              Serial.println(); 
                                                                                             } else {
                                                                                                     Serial.print("Rele 3S ON");
                                                                                                     Serial.println();      
                                                                                                    }
                                                                         t=t2;
                                                                         t_att = millis();      
                                                                         flag_t2_settato = true;
                                                                         flag_t1_settato = false;
                                                                         }
                                                                    }
                 if (tc-t_att<=t) return true;
                 else if (stato2) {
                                   reset_flags();
                                   digitalWrite(Rele1,LOW);
                                   Serial.print("Rele Spento");
                                   Serial.println();
                                   reset_timer();
                                   return false;
                                   }
                }

void switch2() {
                if (leggiswitch2) {
                                   t1 = 5*1000;
                                   t2 = 3*1000;
                                  }
               }

void reset_timer() {
                    t_att = 0;
                    t = 0;
                   }

void reset_flags () { 
                     flag_timer = false;
                     flag_t1_settato = false;
                     flag_t2_settato = false;
                    }
